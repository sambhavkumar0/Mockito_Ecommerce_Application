<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' - Mokito Store'">Product Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Navbar Fragment -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="flex-grow-1">
    <div class="container my-5">
        <div class="row">
            <!-- Product Image -->
            <div class="col-md-6">
                <img th:src="@{${product.imageUrl}}" class="product-detail-image" alt="Product Image" 
                     th:if="${product.imageUrl != null and !product.imageUrl.isEmpty()}"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="product-detail-image" th:unless="${product.imageUrl != null and !product.imageUrl.isEmpty()}" 
                     style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center; color: #6c757d;">
                    <i class="bi bi-image"></i> No Image Available
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-md-6">
                <h2 th:text="${product.name}">Product Name</h2>
                <h4 class="text-success" th:text="'â‚¹' + ${product.price}">Price</h4>
                <p th:text="${product.description}">Product description goes here...</p>

                <!-- Stock Status Display -->
                <div class="mb-3">
                    <span th:if="${product.stock == 0}" class="badge bg-danger fs-6">
                        <i class="bi bi-x-circle"></i> Out of Stock
                    </span>
                    <span th:if="${product.stock > 0 and product.stock <= 5}" class="badge bg-warning fs-6">
                        <i class="bi bi-exclamation-triangle"></i> Hurry! Only <span th:text="${product.stock}"></span> left
                    </span>
                    <span th:if="${product.stock > 5}" class="badge bg-success fs-6">
                        <i class="bi bi-check-circle"></i> In Stock
                    </span>
                </div>

                <!-- Quantity Input -->
                <div class="mb-3" th:if="${product.stock > 0}">
                    <label for="quantity" class="form-label">Quantity:</label>
                    <input type="number" id="quantity" value="1" min="1" th:max="${product.stock}" class="form-control w-25 d-inline-block">
                    <small class="form-text text-muted" th:if="${product.stock <= 5}">
                        Maximum available: <span th:text="${product.stock}"></span>
                    </small>
                </div>

                <!-- Hidden Product ID -->
                <input type="hidden" id="productId" th:value="${product.id}" />

                <!-- Add to Cart Button -->
                <button class="btn btn-success" id="addToCartBtn" th:disabled="${product.stock == 0}">
                    <span th:if="${product.stock > 0}">Add to Cart</span>
                    <span th:if="${product.stock == 0}">Out of Stock</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.getElementById('addToCartBtn').addEventListener('click', async () => {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const token = localStorage.getItem('jwtToken');
            const productId = document.getElementById('productId').value;
            const maxStock = parseInt(document.getElementById('quantity').max) || 0;

            if (!token) {
                alert("Please login first!");
                window.location.href = "/login";
                return;
            }

            // Check if quantity exceeds available stock
            if (quantity > maxStock) {
                alert(`Sorry! Only ${maxStock} items available in stock.`);
                return;
            }

            try {
                const response = await fetch(`/api/cart/add/${productId}?quantity=${quantity}`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Failed to add to cart");
                }

                // Optionally, show a toast or inline message instead of alert
                alert("Product added to cart!");
                window.location.href = "/cart"; // Redirect to cart page
            } catch (err) {
                console.error(err);
                alert("Error adding product to cart. Try again.");
            }
        });
    </script>
    </main>

    <!-- Include Footer Fragment -->
    <div th:replace="~{fragments/footer :: footer}"></div>

</body>

</html>